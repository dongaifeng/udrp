<template>
  <el-form
    ref="form"
    class="page-form"
    :class="className"
    :model="formData"
    :rules="_rules"
    :label-width="labelWidth"
  >
    <el-row>
      <el-col v-for="(item, index) in fieldList.filter(item => !item.hidden) " :key="index" :span="parseInt(item.span) || span" :required="createRules(item)">
        <el-form-item
          :prop="item.value"
          :label="item.label"
          :class="item.className"
        >
          <!-- solt -->
          <template v-if="item.type === 'slot'">
            <slot :name="'form-' + item.value" />
          </template>

          <!-- 普通输入框 -->
          <el-input
            v-if="item.type === 'input' || item.type === 'password'"
            v-model="formData[item.value]"
            :type="item.type"
            :disabled="item.disabled"
            :placeholder="getPlaceholder(item)"
            @focus="handleEvent(item.event)"
          />
          <!-- 文本输入框 -->
          <el-input
            v-if="item.type === 'textarea'"
            v-model.trim="formData[item.value]"
            :type="item.type"
            :disabled="item.disabled"
            :placeholder="getPlaceholder(item)"
            :autosize="item.autosize || {minRows: 4, maxRows: 10}"
            @focus="handleEvent(item.event)"
          />
          <!-- 复选框 -->
          <el-checkbox
            v-if="item.type === 'checkbox'"
            v-model.trim="formData[item.value]"
            :disabled="item.disabled"
            @change="handleEvent(item.event, formData[item.value])"
          />

          <!-- 计数器 -->
          <el-input-number
            v-if="item.type === 'inputNumber'"
            v-model="formData[item.value]"
            size="small"
            :min="item.min"
            :max="item.max"
            @change="handleEvent(item.event, formData[item.value])"
          />
          <!-- 选择框 -->
          <el-select
            v-if="item.type === 'select'"
            v-model="formData[item.value]"
            :disabled="item.disabled"
            :clearable="!item.clearable"
            :filterable="item.filterable"
            :placeholder="getPlaceholder(item)"
            @change="handleEvent(item.event, formData[item.value])"
          >
            <el-option
              v-for="(childItem, childIndex) in (typeof item.list === 'string' ? listTypeInfo[item.list] : item.list)"
              :key="childIndex"
              :label="childItem.ClassName"
              :value="childItem.ClassCode"
            />
          </el-select>
          <!-- 日期选择框 -->
          <el-date-picker
            v-if="item.type === 'date'"
            v-model="formData[item.value]"
            :type="item.dateType"
            :picker-options="item.TimePickerOptions"
            :clearable="item.clearable"
            :disabled="item.disabled"
            :placeholder="getPlaceholder(item)"
            @focus="handleEvent(item.event)"
          />
          <!-- 信息展示框 -->
          <el-tag v-if="item.type === 'tag'">
            {{ $fn.getDataName({dataList: listTypeInfo[item.list], value: 'value', label: 'key', data: formData[item.value]}) || '-' }}
          </el-tag>
        </el-form-item>
      </el-col>
    </el-row>

  </el-form>
</template>

<script>
export default {
  name: 'CompForm',
  props: {
    span: {
      type: Number,
      default: 6
    },
    // 自定义类名
    className: {
      type: String
    },
    // 表单数据
    formData: {
      type: Object
    },
    // 相关字段
    fieldList: {
      type: Array
    },
    // 验证规则
    rules: {
      type: Object
    },
    // 相关的列表
    listTypeInfo: {
      type: Object
    },
    // label宽度
    labelWidth: {
      type: String,
      default: '120px'
    },
    refObj: {
      type: Object
    }
  },
  data() {
    return {
    }
  },
  computed: {
    _rules() {
      return this.rules
    }
  },
  watch: {
    formData: {
      handler: function(val) {
        // 将form实例返回到父级
        this.$emit('update:refObj', this.$refs.form)
      },
      deep: true // 深度监听
    }
  },
  mounted() {
    // 将form实例返回到父级
    this.$emit('update:refObj', this.$refs.form)
  },
  methods: {
    // 获取字段列表
    // getConfigList() {
    //   return this.fieldList.filter(item => !item.hasOwnProperty('show') || (item.hasOwnProperty('show') && item.show))
    // },
    // 得到placeholder的显示
    getPlaceholder(row) {
      let placeholder
      if (row.type === 'input' || row.type === 'textarea') {
        placeholder = '请输入' + row.label
      } else if (row.type === 'select' || row.type === 'time' || row.type === 'date') {
        placeholder = '请选择' + row.label
      } else {
        placeholder = row.label
      }
      return placeholder
    },
    // 绑定的相关事件
    handleEvent(event, data) {
      this.$emit('handleEvent', event, data)
    },
    // 派发按钮点击事件
    handleClick(event, data) {
      this.$emit('handleClick', event, data)
    },
    createRules(item) {
      if (item.required) {
        console.log(item)
        const obj = { required: true, message: `请输入${item.label}`, trigger: 'blur,change' }
        if (!this._rules[item.value]) {
          this._rules[item.value] = [obj]
        }
      }
      return null
    }
  }
}
</script>

<style lang="scss" scoped>
// 自定义form相关
// .page-form{
//   .el-form-item{
//     display: inline-block;
//     // float: left;
//     width: 48%;
//     .el-form-item__content{
//       .el-input, .el-select, .el-textarea{
//         width: 240px;
//       }
//       .el-input-number{
//         .el-input{
//           width: inherit;
//         }
//       }
//     }
//   }
//   .el-form-block{
//     display: block;
//     width: 100%;
//     .el-form-item__content{
//       .el-textarea{
//         width: 100%;
//       }
//     }
//   }
// }
// .page-form-block{
//   .el-form-item{
//     display: block;
//     .el-form-item__content{
//       .el-input, .el-select, .el-textarea{
//         width: inherit;
//       }
//       .el-input-number{
//         .el-input{
//           width: inherit;
//         }
//       }
//     }
//   }
//   .el-form-block{
//     display: block;
//     width: 100%;
//     .el-form-item__content{
//       .el-textarea{
//         width: 100%;
//       }
//     }
//   }
// }
</style>
